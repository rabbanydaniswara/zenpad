<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZenPad | Secure Storage</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-sidebar: #181818;
            --bg-main: #1f1f1f;
            --text-primary: #e0e0e0;
            --text-secondary: #858585;
            --accent: #4caf50;
            --accent-hover: #43a047;
            --danger: #e57373;
            --item-hover: #2a2d2e;
            --border: #333;
            --btn-secondary: #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        aside {
            width: 280px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            z-index: 10;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }

        .add-btn {
            width: 100%;
            padding: 12px;
            background-color: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
        }
        .add-btn:hover { background-color: var(--accent-hover); }

        .notes-list {
            list-style: none;
            overflow-y: auto;
            flex-grow: 1;
        }

        .note-item {
            padding: 15px 20px;
            border-bottom: 1px solid #252525;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .note-item:hover { background-color: var(--item-hover); }
        .note-item.active { background-color: #2d2d30; border-left: 3px solid var(--accent); }

        .note-info { overflow: hidden; flex-grow: 1; margin-right: 10px; }
        .note-title { display: block; font-weight: 500; font-size: 0.95rem; margin-bottom: 4px; color: #fff; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .note-preview { display: block; font-size: 0.8rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .delete-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 5px;
            opacity: 0; 
            transition: opacity 0.2s;
        }
        .note-item:hover .delete-btn, .note-item.active .delete-btn { opacity: 1; }
        .delete-btn:hover { color: var(--danger); }

        /* --- DATA MANAGEMENT (NEW) --- */
        .sidebar-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }
        
        .data-btn {
            flex: 1;
            padding: 8px;
            background-color: var(--btn-secondary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .data-btn:hover { background-color: #444; color: #fff; }

        /* --- MAIN EDITOR --- */
        main {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 40px 60px;
        }

        .editor-title {
            background: transparent;
            border: none;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            width: 100%;
        }
        
        .editor-body {
            flex-grow: 1;
            background: transparent;
            border: none;
            resize: none;
            font-size: 1.1rem;
            line-height: 1.7;
            color: #d0d0d0;
        }

        /* Hidden File Input */
        #fileInput { display: none; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #444; border-radius: 3px; }

        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { width: 100%; height: 40vh; border-right: none; border-bottom: 1px solid var(--border); }
            main { padding: 20px; height: 60vh; }
            .editor-title { font-size: 1.8rem; }
        }
    </style>
</head>
<body>

    <aside>
        <div class="sidebar-header">
            <button class="add-btn" onclick="addNewNote()">+ New Note</button>
        </div>
        <ul class="notes-list" id="notesList"></ul>
        
        <div class="sidebar-footer">
            <button class="data-btn" onclick="exportData()" title="Download Backup">ðŸ’¾ Save File</button>
            <button class="data-btn" onclick="triggerImport()" title="Restore from Backup">ðŸ“‚ Load File</button>
            <input type="file" id="fileInput" accept=".json" onchange="importData(this)">
        </div>
    </aside>

    <main id="mainEditor">
        <div style="display:flex; height:100%; justify-content:center; align-items:center; color:#555;">
            Select a note or Load a File
        </div>
    </main>

    <script>
        // --- LOGIC ---
        let notes = [];
        let activeNoteId = null;

        const notesListEl = document.getElementById('notesList');
        const mainEditorEl = document.getElementById('mainEditor');

        // 1. Initialize
        function init() {
            const savedNotes = localStorage.getItem('zenpad_notes');
            if (savedNotes) {
                notes = JSON.parse(savedNotes);
            } else {
                // Initial welcome note
                notes = [{
                    id: Date.now(),
                    title: "Readme",
                    body: "Welcome to ZenPad v3.\n\n1. Type anything, it saves to browser memory instantly.\n2. To be 'History Clear Proof', click 'Save File' below.\n3. This downloads a .json file.\n4. If you clear your history, click 'Load File' and select that JSON."
                }];
                saveToStorage();
            }
            renderNotesList();
            if(notes.length > 0) setActiveNote(notes[0].id);
        }

        // 2. Render List
        function renderNotesList() {
            notesListEl.innerHTML = '';
            notes.sort((a, b) => b.id - a.id).forEach(note => {
                const li = document.createElement('li');
                li.className = `note-item ${note.id === activeNoteId ? 'active' : ''}`;
                li.innerHTML = `
                    <div class="note-info">
                        <span class="note-title">${escapeHtml(note.title) || 'Untitled'}</span>
                        <span class="note-preview">${escapeHtml(note.body.substring(0, 30))}...</span>
                    </div>
                    <button class="delete-btn" onclick="deleteNote(${note.id}, event)">&times;</button>
                `;
                li.onclick = () => setActiveNote(note.id);
                notesListEl.appendChild(li);
            });
        }

        // 3. Render Editor
        function renderEditor(id) {
            const note = notes.find(n => n.id === id);
            if (!note) return;

            mainEditorEl.innerHTML = `
                <input type="text" class="editor-title" id="noteTitle" value="${escapeHtml(note.title)}" placeholder="Title">
                <textarea class="editor-body" id="noteBody" placeholder="Start typing...">${escapeHtml(note.body)}</textarea>
            `;

            // Listeners
            document.getElementById('noteTitle').addEventListener('input', (e) => updateNote(id, {title: e.target.value}));
            document.getElementById('noteBody').addEventListener('input', (e) => updateNote(id, {body: e.target.value}));
        }

        // 4. CRUD Operations
        function setActiveNote(id) {
            activeNoteId = id;
            renderNotesList();
            renderEditor(id);
        }

        function addNewNote() {
            const newNote = { id: Date.now(), title: "", body: "" };
            notes.unshift(newNote);
            saveToStorage();
            setActiveNote(newNote.id);
        }

        function updateNote(id, fields) {
            const note = notes.find(n => n.id === id);
            Object.assign(note, fields);
            saveToStorage();
            // Live update sidebar text without full re-render
            const li = Array.from(notesListEl.children).find(item => item.innerHTML.includes(`deleteNote(${id}`));
            if(li) {
                if(fields.title !== undefined) li.querySelector('.note-title').textContent = fields.title || 'Untitled';
                if(fields.body !== undefined) li.querySelector('.note-preview').textContent = fields.body.substring(0, 30) + '...';
            }
        }

        function deleteNote(id, event) {
            event.stopPropagation();
            if(confirm('Delete this note?')) {
                notes = notes.filter(n => n.id !== id);
                saveToStorage();
                activeNoteId = null;
                renderNotesList();
                mainEditorEl.innerHTML = '';
            }
        }

        function saveToStorage() {
            localStorage.setItem('zenpad_notes', JSON.stringify(notes));
        }

        // --- FILE PERSISTENCE (THE "BROWSER PROOF" PART) ---

        // A. Export (Save to File)
        function exportData() {
            const dataStr = JSON.stringify(notes, null, 2); // Pretty print JSON
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            // Create a fake link to trigger download
            const a = document.createElement('a');
            a.href = url;
            const date = new Date().toISOString().slice(0, 10);
            a.download = `zenpad_backup_${date}.json`; 
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // B. Import (Load from File)
        function triggerImport() {
            document.getElementById('fileInput').click();
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedNotes = JSON.parse(e.target.result);
                    if (Array.isArray(importedNotes)) {
                        if(confirm("This will replace current notes with the backup. Continue?")) {
                            notes = importedNotes;
                            saveToStorage(); // Save to localStorage immediately
                            init(); // Reload UI
                            alert("Backup restored successfully!");
                        }
                    } else {
                        alert("Invalid file format.");
                    }
                } catch (err) {
                    alert("Error reading file.");
                }
            };
            reader.readAsText(file);
            // Reset input so you can load the same file again if needed
            input.value = ''; 
        }

        function escapeHtml(text) {
             if (!text) return "";
             return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        init();
    </script>
</body>
</html>